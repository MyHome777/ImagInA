<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remover Fondo Pro - ImaginA Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Patrón de transparencia */
        .checkerboard {
            background-color: #ffffff;
            background-image: 
                linear-gradient(45deg, #f3e8ff 25%, transparent 25%), 
                linear-gradient(-45deg, #f3e8ff 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f3e8ff 75%), 
                linear-gradient(-45deg, transparent 75%, #f3e8ff 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Animación suave para el Drag & Drop */
        #drop-zone {
            transition: all 0.3s ease-in-out;
        }
        #drop-zone.dragging {
            background-color: #f3e8ff; /* bg-purple-100 */
            border-color: #9333ea; /* border-purple-600 */
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(147, 51, 234, 0.3);
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8845528388052409"
     crossorigin="anonymous"></script>
    
</head>
<body class="bg-purple-50 min-h-screen text-slate-800 selection:bg-purple-200">

    <nav class="bg-white border-b border-purple-100 sticky top-0 z-50 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 text-purple-700 font-bold text-lg md:text-xl">
                <i class="fas fa-magic"></i> <span class="hidden xs:inline">ImaginA Tools</span><span class="xs:hidden">ImaginA</span>
            </div>
            <a href="index.html" class="text-sm text-slate-500 hover:text-purple-600 font-medium transition-colors flex items-center gap-1 py-2 px-3 rounded-lg hover:bg-purple-50">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </nav>

    <div class="w-full max-w-4xl mx-auto px-4 py-6 md:py-12">
        
        <div class="text-center mb-6 md:mb-10">
            <div class="inline-block p-3 rounded-full bg-purple-100 text-purple-600 mb-3 text-xl md:text-2xl">
                <i class="fas fa-eraser"></i>
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">Removedor de Fondo</h1>
            <p class="text-sm md:text-base text-slate-500 px-4">Arrastra una imagen o súbela y la IA hará la magia.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl shadow-purple-100/50 overflow-hidden border border-purple-50">
            
            <div id="input-step" class="p-6 md:p-12">
                <label class="block w-full cursor-pointer group">
                    <div id="drop-zone" class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-8 md:p-16 text-center hover:bg-purple-50 hover:border-purple-400 relative">
                        
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-white text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6 shadow-md border border-purple-100 group-hover:scale-110 transition-transform pointer-events-none">
                            <i class="fas fa-cloud-upload-alt text-2xl md:text-3xl"></i>
                        </div>
                        
                        <h3 class="font-bold text-lg md:text-xl text-purple-900 pointer-events-none">Arrastra tu imagen aquí</h3>
                        <p class="text-xs md:text-sm text-purple-400 mt-2 pointer-events-none">o haz clic para buscar en tus archivos</p>
                        
                        <div class="mt-6 inline-block bg-purple-600 text-white px-6 py-2 rounded-full text-sm font-semibold shadow-lg shadow-purple-200 pointer-events-none">
                            Elegir Foto
                        </div>
                        
                        <input type="file" id="file-upload" class="hidden" accept="image/*">
                    </div>
                </label>
                <p class="text-center text-xs text-slate-400 mt-4 mx-4">
                    <i class="fas fa-info-circle"></i> La primera vez descargará el modelo (aprox 80MB).
                </p>
            </div>

            <div id="processing-step" class="hidden p-10 md:p-20 text-center">
                <div class="relative w-20 h-20 md:w-24 md:h-24 mx-auto mb-6">
                    <div class="absolute inset-0 border-4 border-purple-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-purple-600 rounded-full border-t-transparent animate-spin"></div>
                    <i class="fas fa-magic absolute inset-0 flex items-center justify-center text-purple-300 text-xl md:text-2xl"></i>
                </div>
                <h3 class="text-lg md:text-xl font-bold text-slate-800">Limpiando fondo...</h3>
                <p id="status-msg" class="text-xs md:text-sm text-slate-500 mt-2">Iniciando motor de IA...</p>
                
                <div id="progress-container" class="w-full max-w-xs md:max-w-md mx-auto bg-slate-100 rounded-full h-2 mt-6 hidden overflow-hidden">
                    <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div id="result-step" class="hidden">
                <div class="flex flex-col md:grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-purple-100">
                    
                    <div class="h-80 md:h-[500px] p-4 md:p-6 flex flex-col items-center justify-center bg-slate-50 relative group w-full">
                        <span class="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase tracking-wider bg-white/50 px-2 py-1 rounded">Original</span>
                        <img id="img-original" class="max-h-full max-w-full object-contain rounded-lg shadow-sm">
                    </div>
                    
                    <div class="h-80 md:h-[500px] p-4 md:p-6 flex flex-col items-center justify-center checkerboard relative w-full">
                        <span class="absolute top-4 left-4 text-xs font-bold text-purple-600 uppercase tracking-wider bg-white/90 px-2 py-1 rounded shadow-sm z-10">Resultado ✨</span>
                        <img id="img-result" class="max-h-full max-w-full object-contain relative z-10 filter drop-shadow-xl">
                    </div>
                </div>
                
                <div class="p-4 md:p-6 bg-white border-t border-purple-50 flex flex-col sm:flex-row justify-center gap-3 md:gap-4">
                    <button onclick="location.reload()" class="w-full sm:w-auto px-6 py-3 bg-white border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-purple-600 font-medium transition-colors flex items-center justify-center gap-2 shadow-sm">
                        <i class="fas fa-redo"></i> <span class="sm:hidden">Empezar de nuevo</span><span class="hidden sm:inline">Nueva</span>
                    </button>
                    <a id="download-btn" class="w-full sm:w-auto px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg shadow-purple-200 flex items-center justify-center gap-2 cursor-pointer transition-all transform active:scale-95">
                        <i class="fas fa-download"></i> Descargar HD
                    </a>
                </div>
            </div>

            <div id="error-msg" class="hidden p-6 bg-red-50 border-t border-red-100">
                <div class="flex flex-col items-center text-center text-red-600">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <span class="font-bold">Algo salió mal</span>
                    <span id="error-text" class="text-sm mt-1 text-red-400">Error al procesar</span>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-100 rounded-lg text-xs font-bold uppercase tracking-wide">Intentar de nuevo</button>
                </div>
            </div>
        </div>
        
        <p class="text-center text-xs text-purple-300 mt-8 mb-4 px-4">
            Powered by ImaginA Tools & RMBG-1.4<br>
            Privacidad total: Todo sucede en tu dispositivo.
        </p>
    </div>

    <script type="module">
        import { env, AutoModel, AutoProcessor, RawImage } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0';

        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const elements = {
            fileUpload: document.getElementById('file-upload'),
            dropZone: document.getElementById('drop-zone'), // Nueva referencia
            inputStep: document.getElementById('input-step'),
            processingStep: document.getElementById('processing-step'),
            resultStep: document.getElementById('result-step'),
            statusMsg: document.getElementById('status-msg'),
            progressBar: document.getElementById('progress-bar'),
            progressContainer: document.getElementById('progress-container'),
            errorMsg: document.getElementById('error-msg'),
            imgOriginal: document.getElementById('img-original'),
            imgResult: document.getElementById('img-result'),
            downloadBtn: document.getElementById('download-btn')
        };
        
        let model = null;
        let processor = null;

        // --- FUNCIONES DE DRAG & DROP ---
        
        // Evitar comportamiento por defecto (abrir imagen en pestaña)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            elements.dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Efectos visuales al arrastrar
        ['dragenter', 'dragover'].forEach(eventName => {
            elements.dropZone.addEventListener(eventName, () => elements.dropZone.classList.add('dragging'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            elements.dropZone.addEventListener(eventName, () => elements.dropZone.classList.remove('dragging'), false);
        });

        // Manejar la caída del archivo
        elements.dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if(files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    startProcessing(file);
                } else {
                    alert("Por favor sube solo archivos de imagen (JPG, PNG, WEBP).");
                }
            }
        }

        // --- FIN DRAG & DROP ---

        async function loadModel() {
            if (model) return;
            
            elements.statusMsg.innerText = "Descargando IA (solo la primera vez)...";
            elements.progressContainer.classList.remove('hidden');

            try {
                const model_id = 'briaai/RMBG-1.4';
                model = await AutoModel.from_pretrained(model_id, {
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const percent = Math.round((data.loaded / data.total) * 100);
                            elements.progressBar.style.width = `${percent}%`;
                            if(percent < 100) elements.statusMsg.innerText = `Cargando IA: ${percent}%`;
                        }
                    }
                });
                processor = await AutoProcessor.from_pretrained(model_id);
                elements.progressContainer.classList.add('hidden');
            } catch (err) {
                throw new Error("Error de conexión al cargar la IA.");
            }
        }

        async function removeBackground(file) {
            try {
                const originalUrl = URL.createObjectURL(file);
                elements.imgOriginal.src = originalUrl;

                await loadModel();
                elements.statusMsg.innerText = "Eliminando imperfecciones...";

                const image = await RawImage.fromURL(originalUrl);
                const { pixel_values } = await processor(image);
                const { output } = await model({ input: pixel_values });
                
                const mask = await RawImage.fromTensor(output[0].mul(255).to('uint8')).resize(image.width, image.height);
                
                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');

                const imgElement = new Image();
                imgElement.src = originalUrl;
                await new Promise(r => imgElement.onload = r);
                ctx.drawImage(imgElement, 0, 0);

                const imgData = ctx.getImageData(0, 0, image.width, image.height);
                const maskData = mask.data;

                // --- ALGORITMO MEJORADO PARA QUITAR MANCHITAS ---
                for (let i = 0; i < imgData.data.length; i += 4) {
                    let alpha = maskData[i / 4];
                    
                    // LÓGICA MEJORADA:
                    // 1. Umbral bajo más agresivo (105): Elimina cualquier mancha grisácea o semi-transparente del fondo.
                    // 2. Interpolación suave: Si el pixel está entre 105 y 220, calculamos una transición suave.
                    
                    if (alpha < 105) { 
                        alpha = 0; // Eliminación total de ruido y manchitas
                    } else if (alpha > 220) {
                        alpha = 255; // Sujeto sólido
                    } else {
                        // Suavizado de bordes (Anti-aliasing manual)
                        // Mapeamos el rango intermedio (105-220) a (0-255)
                        alpha = (alpha - 105) * (255 / 115);
                    }
                    
                    imgData.data[i + 3] = alpha; 
                }

                ctx.putImageData(imgData, 0, 0);

                const finalUrl = canvas.toDataURL('image/png');
                elements.imgResult.src = finalUrl;
                elements.downloadBtn.href = finalUrl;
                elements.downloadBtn.download = `ImaginA-Clean-${Date.now()}.png`;

                elements.processingStep.classList.add('hidden');
                elements.resultStep.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                elements.processingStep.classList.add('hidden');
                elements.inputStep.classList.remove('hidden');
                elements.errorMsg.classList.remove('hidden');
                document.getElementById('error-text').innerText = "Memoria insuficiente. Cierra pestañas e intenta de nuevo.";
            }
        }

        // Wrapper para iniciar el proceso desde botón o drop
        async function startProcessing(file) {
            elements.inputStep.classList.add('hidden');
            elements.processingStep.classList.remove('hidden');
            elements.errorMsg.classList.add('hidden');
            await removeBackground(file);
        }

        elements.fileUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            startProcessing(file);
        });
    </script>
</body>
</html>