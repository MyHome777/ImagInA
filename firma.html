<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firmar PDF Profesional - ImaginA Tools</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #333;
            --error: #ef4444;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text);
            overscroll-behavior: none; 
            overflow-x: hidden;
        }

        .navbar {
            width: 100%;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .navbar a {
            text-decoration: none;
            color: var(--text);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-card {
            background: var(--card-bg);
            width: 95%;
            max-width: 800px;
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            text-align: center;
            box-sizing: border-box;
            margin-bottom: 40px;
            position: relative;
        }

        h1 { color: var(--primary); margin: 10px 0; font-size: 1.5rem; }
        p.subtitle { color: #666; margin-bottom: 20px; font-size: 0.9rem; }

        .inputs-grid { display: flex; gap: 15px; margin-bottom: 20px; flex-direction: column; }
        @media(min-width: 768px) { .inputs-grid { flex-direction: row; } h1 { font-size: 1.8rem; } .main-card { padding: 40px; } }

        .upload-box {
            width: 100%;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
            box-sizing: border-box;
        }
        .upload-box:hover, .upload-box:active { border-color: var(--primary); background-color: #ecfdf5; }
        .upload-text h4 { margin: 0; color: #333; font-size: 1rem; }
        .upload-text p { margin: 5px 0 0 0; font-size: 0.8rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
        .file-check { margin-left: auto; color: var(--primary); display: none; font-size: 1.2rem; }

        /* Preview Area */
        #preview-stage-container {
            display: none;
            margin-top: 20px;
            background: #e5e7eb;
            padding: 10px;
            border-radius: 10px;
            overflow: hidden; 
            border: 1px solid #d1d5db;
        }

        #pdf-container {
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto;
            line-height: 0;
            background: white;
            user-select: none;
            max-width: 100%;
        }
        
        #pdf-render { width: 100%; height: auto; display: block; }

        /* LA FIRMA (Ghost) */
        #signature-ghost {
            position: absolute;
            /* width se define dinámicamente */
            height: auto; 
            border: 2px dashed var(--primary);
            background: rgba(5, 150, 105, 0.2);
            cursor: grab;
            display: none;
            top: 50%; left: 50%;
            transform: translate(0, 0); /* Quitamos translate negativo para simplificar calculo */
            z-index: 10;
            touch-action: none;
        }
        #signature-ghost img { width: 100%; height: 100%; pointer-events: none; display: block; }

        .resize-handle {
            width: 24px; height: 24px; /* Más grande para mejor agarre */
            background: var(--primary);
            position: absolute; right: -12px; bottom: -12px;
            border-radius: 50%; border: 3px solid white;
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .final-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-action {
            background: var(--primary); color: white; border: none; padding: 15px 30px;
            font-size: 1.1rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            width: 100%; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }
        .btn-action:disabled { background: #ccc; box-shadow: none; }
        
        input[type="file"] { display: none; }

        /* --- MODAL DE ALERTA --- */
        #custom-alert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .alert-content {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; max-width: 90%; width: 350px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .alert-icon { font-size: 3rem; color: var(--error); margin-bottom: 15px; }
        .alert-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 10px; color: var(--text); }
        .alert-msg { color: #666; margin-bottom: 20px; font-size: 0.95rem; }
        .alert-btn {
            background: var(--error); color: white; border: none; padding: 10px 25px;
            border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8845528388052409"
     crossorigin="anonymous"></script>
</head>
<body>
    <div class="navbar"><a href="index.html"><i class="fas fa-arrow-left"></i> Volver al Menú</a></div>
    
    <div class="main-card">
        <div style="background: #ecfdf5; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto;">
            <i class="fas fa-file-signature" style="font-size: 24px; color: var(--primary);"></i>
        </div>
        <h1>Firmar PDF</h1>
        <p class="subtitle">Sube tu PDF y tu firma (PNG/JPG).</p>

        <div class="inputs-grid">
            <div class="upload-box" id="drop-zone-pdf" onclick="document.getElementById('pdfInput').click()">
                <i class="fas fa-file-pdf icon-main" style="font-size: 1.5rem; color: var(--primary);"></i>
                <div class="upload-text"><h4>Documento PDF</h4><p id="pdfName">Seleccionar...</p></div>
                <i class="fas fa-check-circle file-check" id="pdfCheck"></i>
            </div>
            <input type="file" id="pdfInput" accept=".pdf" onchange="handleFileSelect(this, 'pdf')">

            <div class="upload-box" id="drop-zone-firma" onclick="document.getElementById('firmaInput').click()">
                <i class="fas fa-signature icon-main" style="font-size: 1.5rem; color: var(--primary);"></i>
                <div class="upload-text"><h4>Tu Firma</h4><p id="firmaName">Imagen...</p></div>
                <i class="fas fa-check-circle file-check" id="firmaCheck"></i>
            </div>
            <input type="file" id="firmaInput" accept="image/png, image/jpeg" onchange="handleFileSelect(this, 'firma')">
        </div>

        <div id="preview-stage-container">
            <p style="color: #666; font-size: 0.8rem; margin-bottom: 10px;"><i class="fas fa-hand-pointer"></i> Arrastra la firma con el dedo para colocarla.</p>
            <div id="pdf-container">
                <canvas id="pdf-render"></canvas>
                <div id="signature-ghost">
                    <img id="ghost-img" src="">
                    <div class="resize-handle" id="resizer"></div>
                </div>
            </div>
        </div>

        <div class="final-controls">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; justify-content: center;">
                <input type="checkbox" id="checkAllPages" style="width: 20px; height: 20px;">
                <label for="checkAllPages">Firmar en <b>TODAS</b> las páginas</label>
            </div>
            <button id="btnFirmar" class="btn-action" onclick="enviarFirma()" disabled>Firmar Documento ✍️</button>
            <p id="status" style="margin-top: 10px; font-weight: bold;"></p>
        </div>
    </div>

    <div id="custom-alert">
        <div class="alert-content">
            <div class="alert-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="alert-title">¡Ups! Archivo no válido</h3>
            <p id="alert-message" class="alert-msg">Por favor verifica el formato.</p>
            <button class="alert-btn" onclick="closeAlert()">Entendido</button>
        </div>
    </div>

    <script>
        let pdfDoc = null;
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');
        const ghost = document.getElementById('signature-ghost');
        const container = document.getElementById('pdf-container');
        const previewStage = document.getElementById('preview-stage-container');
        const resizer = document.getElementById('resizer');

        // Variables de estado
        let isDragging = false, isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let startX, startWidth;
        // Aspect Ratio real de la imagen de firma
        let firmaAspectRatio = 1; 

        // --- MANEJO DE ARCHIVOS Y ERRORES ---
        function showAlert(msg) {
            document.getElementById('alert-message').innerText = msg;
            document.getElementById('custom-alert').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('custom-alert').style.display = 'none';
        }

        function handleFileSelect(input, type) {
            const file = input.files[0];
            if (!file) return;

            if (type === 'firma') {
                const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    input.value = ""; // Limpiar input
                    showAlert("Solo se permiten imágenes PNG o JPG para la firma.");
                    return;
                }
                loadFirmaPreview(file);
            } else if (type === 'pdf') {
                if (file.type !== 'application/pdf') {
                    input.value = "";
                    showAlert("Por favor sube un archivo PDF válido.");
                    return;
                }
                loadPdfPreview(file);
            }
        }

        // --- Drag & Drop UI ---
        function setupDragDropUI(zoneId, inputId, type) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.background = '#d1fae5'; });
            zone.addEventListener('dragleave', e => { e.preventDefault(); zone.style.background = '#f8fafc'; });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.style.background = '#f8fafc';
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    handleFileSelect(input, type);
                }
            });
        }
        setupDragDropUI('drop-zone-pdf', 'pdfInput', 'pdf');
        setupDragDropUI('drop-zone-firma', 'firmaInput', 'firma');


        async function loadPdfPreview(file) {
            document.getElementById('pdfName').innerText = file.name;
            document.getElementById('pdfCheck').style.display = 'block';
            previewStage.style.display = 'block';
            
            const fileReader = new FileReader();
            fileReader.onload = async function () {
                const typedarray = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                renderPage(pdfDoc.numPages);
            };
            fileReader.readAsArrayBuffer(file);
            checkReady();
        }

        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);
            const containerWidth = document.querySelector('.main-card').clientWidth - 40; 
            const viewportBase = page.getViewport({ scale: 1.0 });
            
            let scale = containerWidth / viewportBase.width;
            if (scale > 1.5) scale = 1.5; 

            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            
            container.style.width = canvas.width + "px";
            container.style.height = canvas.height + "px";
            
            if (document.getElementById('firmaInput').files.length > 0) {
                resetGhostPosition();
                ghost.style.display = 'block';
            }
        }

        function loadFirmaPreview(file) {
            document.getElementById('firmaName').innerText = file.name;
            document.getElementById('firmaCheck').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('ghost-img');
                img.src = e.target.result;
                
                // Calcular Aspect Ratio real para que no se deforme
                const tempImg = new Image();
                tempImg.src = e.target.result;
                tempImg.onload = function() {
                    firmaAspectRatio = tempImg.width / tempImg.height;
                    
                    // Tamaño inicial prudente
                    let initialWidth = container.offsetWidth * 0.3; 
                    if(initialWidth < 80) initialWidth = 80;
                    
                    ghost.style.width = initialWidth + "px";
                    ghost.style.height = (initialWidth / firmaAspectRatio) + "px";
                    
                    if (previewStage.style.display !== 'none') {
                        resetGhostPosition();
                        ghost.style.display = 'block';
                    }
                }
            }
            reader.readAsDataURL(file);
            checkReady();
        }

        function resetGhostPosition() {
            // Centrar firma inicialmente
            const cw = container.offsetWidth;
            const ch = container.offsetHeight;
            const gw = ghost.offsetWidth;
            const gh = ghost.offsetHeight;
            
            ghost.style.left = (cw/2 - gw/2) + "px";
            ghost.style.top = (ch/2 - gh/2) + "px";
        }

        // ==========================================
        // LÓGICA DE MOVIMIENTO CORREGIDA
        // ==========================================

        function startDrag(clientX, clientY, target) {
            if (target === resizer || target.parentElement === resizer) {
                isResizing = true;
                startX = clientX;
                startWidth = ghost.offsetWidth;
            } else {
                isDragging = true;
                const rect = ghost.getBoundingClientRect();
                dragOffset.x = clientX - rect.left;
                dragOffset.y = clientY - rect.top;
            }
        }

        function moveDrag(clientX, clientY) {
            if (isDragging) {
                const rectContainer = container.getBoundingClientRect();
                
                // Calculamos nueva posición teórica
                let newLeft = clientX - rectContainer.left - dragOffset.x;
                let newTop = clientY - rectContainer.top - dragOffset.y;

                // LÍMITES ESTRICTOS (Clamp)
                // Math.max(0, ...) -> No menor que 0
                // Math.min(max, ...) -> No mayor que el ancho/alto contenedor
                const maxW = container.clientWidth - ghost.offsetWidth;
                const maxH = container.clientHeight - ghost.offsetHeight;

                newLeft = Math.max(0, Math.min(newLeft, maxW));
                newTop = Math.max(0, Math.min(newTop, maxH));

                ghost.style.left = newLeft + "px";
                ghost.style.top = newTop + "px";
            }

            if (isResizing) {
                const deltaX = clientX - startX;
                let newWidth = startWidth + deltaX;
                
                // Limites de resize
                const maxWidthAvailable = container.clientWidth - ghost.offsetLeft;
                
                if (newWidth > 40 && newWidth <= maxWidthAvailable) {
                    ghost.style.width = newWidth + "px";
                    ghost.style.height = (newWidth / firmaAspectRatio) + "px"; // Mantener ratio
                }
            }
        }

        function endDrag() {
            isDragging = false;
            isResizing = false;
        }

        // Listeners Globales para evitar que se "suelte" si mueves muy rápido
        // MOUSE
        ghost.addEventListener('mousedown', e => { e.preventDefault(); startDrag(e.clientX, e.clientY, e.target); });
        window.addEventListener('mousemove', e => { if(isDragging || isResizing) moveDrag(e.clientX, e.clientY); });
        window.addEventListener('mouseup', endDrag);

        // TOUCH (Celular)
        ghost.addEventListener('touchstart', e => {
            e.preventDefault(); 
            const touch = e.touches[0];
            startDrag(touch.clientX, touch.clientY, e.target);
        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (isDragging || isResizing) {
                e.preventDefault(); 
                const touch = e.touches[0];
                moveDrag(touch.clientX, touch.clientY);
            }
        }, { passive: false });
        
        window.addEventListener('touchend', endDrag);

        function checkReady() {
            const pdf = document.getElementById('pdfInput').files.length;
            const firm = document.getElementById('firmaInput').files.length;
            document.getElementById('btnFirmar').disabled = !(pdf && firm);
        }

        // ==========================================
        // PROCESAMIENTO PDF FINAL (Corregido)
        // ==========================================

        async function enviarFirma() {
            const btn = document.getElementById('btnFirmar');
            const status = document.getElementById('status');
            const pdfFile = document.getElementById('pdfInput').files[0];
            const firmFile = document.getElementById('firmaInput').files[0];
            const aplicarEnTodas = document.getElementById('checkAllPages').checked;

            if (!pdfFile || !firmFile) return;

            btn.disabled = true;
            btn.innerText = "Procesando...";
            status.innerText = "";

            try {
                // 1. Obtener datos geométricos PRECISOS del HTML
                // Usamos offsetLeft/Top relativos al contenedor
                const ghostX = ghost.offsetLeft;
                const ghostY = ghost.offsetTop;
                const ghostW = ghost.offsetWidth;
                const ghostH = ghost.offsetHeight;
                
                const containerW = container.offsetWidth;
                const containerH = container.offsetHeight;

                // Calculamos porcentajes (0.0 a 1.0)
                // X es porcentaje desde la izquierda
                const xPercent = ghostX / containerW;
                // Y es porcentaje desde ARRIBA
                const yPercentFromTop = ghostY / containerH;
                // W es porcentaje del ancho total
                const wPercent = ghostW / containerW;


                // 2. Procesar PDF con pdf-lib
                const pdfBytes = await pdfFile.arrayBuffer();
                const firmBytes = await firmFile.arrayBuffer();
                const pdfDocLib = await PDFLib.PDFDocument.load(pdfBytes);

                let firmaImage;
                if (firmFile.type.includes('jpeg') || firmFile.type.includes('jpg')) {
                    firmaImage = await pdfDocLib.embedJpg(firmBytes);
                } else {
                    firmaImage = await pdfDocLib.embedPng(firmBytes);
                }

                // 3. Estampar
                const pages = pdfDocLib.getPages();
                const indices = aplicarEnTodas ? pages.map((_, i) => i) : [pages.length - 1];

                indices.forEach(index => {
                    const page = pages[index];
                    const { width, height } = page.getSize();

                    // TRADUCCIÓN DE COORDENADAS (La magia para que no salga en la orilla)
                    
                    // 1. Ancho final en PDF
                    const pdfFirmaW = width * wPercent;
                    // 2. Alto proporcional (usando el aspect ratio de la imagen original)
                    const pdfFirmaH = pdfFirmaW / firmaAspectRatio;

                    // 3. Posición X (Izquierda a Derecha) -> Igual que en HTML
                    const pdfX = width * xPercent;

                    // 4. Posición Y (¡INVERTIDA!)
                    // En HTML (0,0) es Arriba-Izquierda.
                    // En PDF (0,0) es Abajo-Izquierda.
                    // Y_PDF = AlturaPagina - (DistanciaDesdeArriba_PDF) - AlturaFirma
                    
                    const distanciaDesdeArriba = height * yPercentFromTop;
                    const pdfY = height - distanciaDesdeArriba - pdfFirmaH;

                    page.drawImage(firmaImage, {
                        x: pdfX,
                        y: pdfY,
                        width: pdfFirmaW,
                        height: pdfFirmaH
                    });
                });

                const pdfBytesModificado = await pdfDocLib.save();
                const blob = new Blob([pdfBytesModificado], { type: "application/pdf" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = pdfFile.name.replace(".pdf", "_firmado.pdf");
                document.body.appendChild(a);
                a.click();
                a.remove();

                status.style.color = "green";
                status.innerText = "¡Listo! Descarga iniciada.";

            } catch (err) {
                console.error(err);
                status.style.color = "red";
                status.innerText = "Error: " + err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "Firmar Documento ✍️";
            }
        }
    </script>
</body>
</html>